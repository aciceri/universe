# agenix-shell

**Shell-integrated secrets management for Nix**

<br>

_A simple yet effective approach to managing encrypted secrets in development environments_

---

## Origin & Core Concept

**NixCon 2023 hackathon idea** <!-- .element: class="fragment" -->

<br>

<div style="display: flex; justify-content: space-between; align-items: center;">

<div style="flex: 1; text-align: center;">
<h3>üîí agenix</h3>
<p style="font-size: 0.8em;">Secrets ‚Üí Files</p>
</div>

<div style="flex: 0; font-size: 2em; margin: 0 2rem;">
‚Üí
</div>

<div style="flex: 1; text-align: center;">
<h3>üêö agenix-shell</h3>
<p style="font-size: 0.8em;">Secrets ‚Üí Variables</p>
</div>

</div>

<!-- .element: class="fragment" -->

Note:
Hi everyone, my name is Andrea and I want to talk about agenix-shell. This talk assumes that you already have a vague idea of what agenix is.
This project started at NixCon 2023 in Darmstadt during the Sunday hackathon.
I had this simple idea: what if instead of writing secrets to files like agenix does, we could make them available as shell environment variables?
I built a quick proof-of-concept and it worked! It's basically a counterpart to agenix. Instead of activation scripts that write files, it generates shell scripts that export variables.
Despite being stupidly simple, I've found it very useful in many projects.

---

## How It Works ‚öôÔ∏è

**Generates shell script that:** <!-- .element: class="fragment" -->

<ul>
<li class="fragment">Decrypts secrets</li>
<li class="fragment">Exports <code>&lt;SECRET_NAME&gt;</code></li>
<li class="fragment">Exports <code>&lt;SECRET_NAME&gt;_PATH</code></li>
</ul>

<br>

**Storage:** <!-- .element: class="fragment" -->

<ul>
<li class="fragment">Linux: <code>$XDG_RUNTIME_DIR</code> (tmpfs)</li>
<li class="fragment">Darwin: dedicated HFS partition</li>
</ul>

Note:
So how does it work?
The interface mimics agenix. I started copying its activation script but it has been heavily changed at this point.
It's fully compatible with agenix CLI, same age keys and encrypted files.
It generates a shell script that first decrypts secrets, then exports two variables per secret:
the secret itself and the file path to the secret.
Secrets go to secure locations,
XDG_RUNTIME_DIR on Linux, which is normally tmpfs,
or a dedicated HFS partition on Darwin.
Can be used as a flake.parts module or standalone.

---

## Demo üé¨

<div id="demo-player"></div>

<!-- .element: class="fragment" -->

Note:
Here you can see the tree of this example flake.
Let me open the flake.nix file and show where we declared our secret and where we source the script generated by agenix-shell.
Now let me show you the file that associates secrets with SSH public keys, it's the same one normally used by agenix.
As you can see, we have the age encrypted file here.
Now let me show you that I can use the usual agenix CLI to open and edit the secret (don't worry, the API token is fake).
Now we enter the shell.
And as you can see, we have two exported variables, one containing the secret and one containing the path to the secret.

---

## Beyond Shells üöÄ

**Not just for development environments!**

<p class="fragment"><strong><a href="https://milano.nix.pizza/">Nix Milano</a></strong> user group's infra repo CI/CD pipelines:<br>
<a href="https://github.com/Nix-Milano/infra/">github.com/Nix-Milano/infra</a></p>

```nix
tofu-apply-in-workflow = pkgs.writeShellApplication {
  # ...
  text = ''
    # ...
    source "${lib.getExe config.agenix-shell.installationScript}"
    tofu init
    tofu apply --auto-approve
    # ...
  '';
};
```

<!-- .element: class="fragment" -->

Only SSH private key stored in GitHub secrets <!-- .element: class="fragment" -->

Note:
Actually, I found myself using agenix-shell not only for development shells!
It can be used for other purposes by sourcing the generated script into other scripts.
Here's how we use it in Nix Milano's CI/CD pipeline. We source the installation script to get all
secrets as environment variables, which are mainly API tokens for Terraform.
This means that we only need one GitHub secret, which is an SSH private key.
All other secrets are stored encrypted in our repo, automatically available when the script runs.

---

## Current Challenges ü§î

<br>

**Design Questions:** <!-- .element: class="fragment" -->

<ul>
<li class="fragment">Is storing encrypted secrets in repos a good idea?</li>
</ul>

<br>

**Technical Limitations:** <!-- .element: class="fragment" -->

<ul>
<li class="fragment">Only supports <strong>agenix</strong> backend</li>
<li class="fragment"><strong>sops-nix</strong> offers more features</li>
<li class="fragment">Could benefit from multiple backend support</li>
</ul>

Note:
Now some challenges.
Is storing encrypted secrets in repos really a good idea?
Even encrypted, they're not code, so should they live in a code repository?
I don't think there is a universal best approach here. Probably depends on context.

Technical limitations: we only support agenix backend, for instance sops-nix would offer more features.
Also it would be nice making agenix-shell backend agnostic.

---

## Future Possibilities üîÆ

**Future Ideas:** <!-- .element: class="fragment" -->

<ul>
<li class="fragment">Should we imitate (or reuse) <strong>clan's vars</strong>?</li>
<li class="fragment">Similar concept being proposed for nixpkgs:
  <ul><li><a href="https://github.com/NixOS/nixpkgs/pull/370444">PR #370444: "implement a secret vars store"</a></li></ul>
</li>
<li class="fragment">Multiple backend support (sops, vault, etc.)</li>
<li class="fragment"><strong><a href="https://github.com/cachix/secretspec">secretspec</a></strong> integration?</li>
</ul>

Note:
Looking forward, interesting possibilities.

There is clan's vars which is very interesting. I still have to try it out but it should allow generating secrets
and having secrets which depend on other secrets.

Also there is a PR which tries to add something similar to clan's vars directly to NixOS.

Should we add more backends besides agenix?

Speaking of this, there is secretspec, a new project by cachix which among other things tries to act as an agnostic layer over
different secret providers. It's probably worth understanding if we can leverage it somehow.

I'm open to any suggestion.

---

# Thank You!

<div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.8em;">
  <div style="flex: 1;">
    <img src="images/me.jpg" alt="Andrea Ciceri" style="border-radius: 50%; width: 8em; height: 8em; object-fit: cover;">
    <p><strong>Andrea Ciceri</strong><br>
    <a href="https://blog.aciceri.dev/contacts/" style="font-size: 0.8em; white-space: nowrap;">blog.aciceri.dev/contacts</a></p>
  </div>
  <div style="flex: 2; text-align: left; padding-left: 2rem;">
    <div style="display: flex; align-items: center; gap: 1em;">
      <div>
        <p><strong>This Presentation:</strong><br>
        <a href="https://github.com/aciceri/agenix-shell-talk" style="white-space: nowrap;">github.com/aciceri/agenix-shell-talk</a></p>
      </div>
      <canvas id="qr-canvas" style="width: 8em; height: 8em;"></canvas>
    </div>
    <p><strong>Build it:</strong></p>
    <code style="font-size: 0.7em;">nix build github:aciceri/agenix-shell-talk</code>
    <p style="margin-top: 2rem;"><em>Thank you for bearing with me!<br>
    Feel free to reach out during the conference - I'd be extremely happy to discuss this project or anything else.</em></p>
  </div>
</div>

Note:
Thanks for bearing with me for these 5 minutes.
Here you can find the references to build this presentation reproducibly, along with my contacts.
I'm probably out of time by now, but if you have any questions I'm completely at your disposal
feel free to stop me around during the conference.
Oh, and on Sunday if you want to hack on agenix-shell together, come find me.

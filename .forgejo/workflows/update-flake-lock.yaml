name: Bump flake inputs
on:
  schedule:
    - cron: "0 15 * * *" # daily at 15:00
  workflow_dispatch:

jobs:
  lockfile:
    runs-on: native
    steps:
      - uses: actions/checkout@v4
        name: Checkout repository
        with:
          token: ${{secrets.SEVENOFNINE_TOKEN}}
      - name: Create new branch from the checked out one
        run: git switch -c update-flake-lock
      - name: Configure git as `Seven of Nix`
        run: |
          git config --global user.email "sevenofnine@stronzi.org"
          git config --global user.name "Seven of Nine"
          git config --global url."https://${{secrets.ACICERI_GITHUB_TOKEN}}@github.com/".insteadOf "https://github.com/"
      - name: Update flake's lockfile and create commit
        run: |
          mkdir -p ~/.config/nix
          echo "access-tokens = github.com=${{secrets.ACICERI_GITHUB_TOKEN}}" >> ~/.config/nix/nix.conf
          nix flake update --commit-lock-file
      - name: Push commit to the `update-flake-lock` remote branch
        run: git push origin --force update-flake-lock # sevenOfNix needs write access to the repository
      - name: Login as `Seven of Nix`
        run: |
          tea logins delete git.aciceri.dev_sevenOfNine || true
          tea logins add --token ${{secrets.SEVENOFNINE_TOKEN}} --url https://git.aciceri.dev
          tea logins default git.aciceri.dev
      - name: Create or update pull request
        run: |
          # Try to create a new PR first
          if ! tea pulls create \
            --repo "$GITHUB_REPOSITORY" \
            --title "Update flake's lockfile" \
            --description "Check the commit description for inputs deltas" \
            --assignees aciceri; then

            echo "PR already exists, updating existing PR..."
            # Force push will update the existing PR
            echo "Branch updated successfully - PR will reflect new changes"
          else
            echo "New PR created successfully"
          fi
